const path = require("path");
const fs = require("fs");
const utils = require("../libs/utils");
const components = require("../libs/components");

const paths = {
    server: path.join(__dirname, ".."),
    config: path.join(__dirname, "..", "conf"),
    lib: path.join(__dirname, "..", "libs"),
}

const internalConfigs = {}

fs.readdirSync(
        paths.config,
        { withFileTypes:true }
    )
    .filter(dirent => !dirent.isDirectory())
    .filter(dirent => dirent.name.includes(".config.js"))
    .map(dirent => dirent.name)
    .map(filename => {
        const id = path.basename(filename, path.extname(filename));
        return {
            id: path.basename(id, path.extname(id)),
            content: require(`${paths.config}/${id}`),
        }
    })
    .forEach(config=>{
        internalConfigs[config.id] = config.content;
    })

require("module").TYPE = {
    ...components,
}


require("module").TYPE = {
        configuration : Symbol("configuration"),
        controller : Symbol("controller"),
        custom : Symbol("custom"),
        library : Symbol("library"),
        middleware : Symbol("middleware"),
        service : Symbol("service"),
        model : Symbol("model"),
    }
    

const scannedJson = utils.ModuleScanner.scan({
        from: internalConfigs.server.rootPath,
        extension: [".js"]
    })

const projectConfigName = path.basename(internalConfigs.server.configFile, path.extname(internalConfigs.server.configFile));
const projectConfigFile = scannedJson[projectConfigName];

if(!projectConfigFile) throw new ReferenceError(`not exists CONFIG FILE on root of project path : ${projectConfigName}`);

const projectConfig = require(`${projectConfigFile}`);

const sourceFiles = scannedJson[projectConfig.project.source]

const sourceModules = []

utils.JSONHandler.action(sourceFiles, {
    returnValue: (value) => {
        sourceModules.push(value);
        return value;
    }
})

console.log(sourceModules);

